<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Conta — Spinassi Chocolates</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/conta.css">
</head>
<body>

<!-- ── HEADER ─────────────────────────────────────────── -->
<header class="acc-header">
    <a href="index.html" class="acc-logo">Spinassi <span>Chocolate</span></a>
    <div class="acc-header-right">
        <a href="index.html" class="acc-back-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
            Voltar à loja
        </a>
    </div>
</header>

<!-- ── LAYOUT ─────────────────────────────────────────── -->
<div class="acc-layout">

    <!-- SIDEBAR -->
    <aside class="acc-sidebar">
        <div class="acc-sidebar-user">
            <div class="acc-avatar-big" id="sidebarAvatar">?</div>
            <div class="acc-sidebar-name" id="sidebarNome">Carregando…</div>
            <div class="acc-sidebar-email" id="sidebarEmail"></div>
        </div>

        <span class="acc-nav-label">Minha conta</span>

        <a href="minha-conta.html" class="acc-nav-item active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
            Meus Dados
        </a>

        <a href="meus-pedidos.html" class="acc-nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
            </svg>
            Meus Pedidos
        </a>

        <a href="lista-desejos.html" class="acc-nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
            Lista de Desejos
        </a>

        <span class="acc-nav-label">Segurança</span>

        <button class="acc-nav-item" onclick="scrollTo('#secSenha')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            Alterar Senha
        </button>

        <span class="acc-nav-label">Sessão</span>

        <button class="acc-nav-item logout-item" onclick="fazerLogout()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
            Sair
        </button>
    </aside>

    <!-- CONTEÚDO -->
    <main class="acc-main">
        <h1 class="acc-page-title">Minha Conta</h1>
        <p class="acc-page-subtitle">Gerencie seus dados pessoais e preferências</p>

        <!-- ── DADOS PESSOAIS ────────────────────────── -->
        <div class="acc-card">
            <div class="acc-card-header">
                <h3>Dados Pessoais</h3>
            </div>
            <div class="acc-card-body">
                <div class="acc-alert" id="alertPerfil"></div>

                <form id="formPerfil" onsubmit="salvarPerfil(event)">
                    <div class="acc-form-grid">

                        <div class="acc-field">
                            <label for="fNome">Nome</label>
                            <input type="text" id="fNome" maxlength="80" required>
                        </div>

                        <div class="acc-field">
                            <label for="fSobrenome">Sobrenome</label>
                            <input type="text" id="fSobrenome" maxlength="80" required>
                        </div>

                        <div class="acc-field full">
                            <label for="fEmail">E-mail</label>
                            <input type="email" id="fEmail" disabled>
                            <span class="acc-field-hint">O e-mail não pode ser alterado.</span>
                        </div>

                        <div class="acc-field">
                            <label for="fTelefone">Telefone</label>
                            <input type="tel" id="fTelefone" maxlength="20">
                        </div>

                        <div class="acc-field">
                            <label for="fGenero">Gênero</label>
                            <select id="fGenero">
                                <option value="">Prefiro não informar</option>
                                <option value="M">Masculino</option>
                                <option value="F">Feminino</option>
                                <option value="NB">Não-binário</option>
                                <option value="ND">Outro</option>
                            </select>
                        </div>

                        <div class="acc-field full" style="display:flex;align-items:center;gap:10px;">
                            <input type="checkbox" id="fNews" style="width:auto;">
                            <label for="fNews" style="text-transform:none;letter-spacing:0;font-size:.84rem;color:var(--text-dark);margin:0;">
                                Quero receber novidades e promoções por e-mail
                            </label>
                        </div>

                    </div>

                    <div style="margin-top:24px;">
                        <button type="submit" class="btn-gold" id="btnSalvarPerfil">
                            <span>Salvar alterações</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ── ALTERAR SENHA ─────────────────────────── -->
        <div class="acc-card" id="secSenha">
            <div class="acc-card-header">
                <h3>Alterar Senha</h3>
            </div>
            <div class="acc-card-body">
                <div class="acc-alert" id="alertSenha"></div>

                <form id="formSenha" onsubmit="alterarSenha(event)">
                    <div class="acc-form-grid">

                        <div class="acc-field full">
                            <label for="fSenhaAtual">Senha atual</label>
                            <div class="acc-pass-wrap">
                                <input type="password" id="fSenhaAtual" autocomplete="current-password" required>
                                <button type="button" class="acc-eye-btn" onclick="toggleEye('fSenhaAtual','eye1')">
                                    <svg id="eye1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="acc-field">
                            <label for="fNovaSenha">Nova senha</label>
                            <div class="acc-pass-wrap">
                                <input type="password" id="fNovaSenha" autocomplete="new-password"
                                       oninput="calcStrength(this.value)" required>
                                <button type="button" class="acc-eye-btn" onclick="toggleEye('fNovaSenha','eye2')">
                                    <svg id="eye2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="strength-track"><div class="strength-fill" id="strengthFill"></div></div>
                            <span class="strength-text" id="strengthText">Mínimo 8 caracteres</span>
                        </div>

                        <div class="acc-field">
                            <label for="fConfirmaSenha">Confirmar nova senha</label>
                            <div class="acc-pass-wrap">
                                <input type="password" id="fConfirmaSenha" autocomplete="new-password" required>
                                <button type="button" class="acc-eye-btn" onclick="toggleEye('fConfirmaSenha','eye3')">
                                    <svg id="eye3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                    </div>

                    <div style="margin-top:24px;">
                        <button type="submit" class="btn-gold" id="btnAlterarSenha">
                            <span>Alterar senha</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </main>
</div>

<script src="../assets/js/api.js"></script>
<script>
/* ============================================================
   MINHA CONTA — lógica
============================================================ */

/* Redireciona se não estiver logado */
if (!SpinassiAPI.sessao.estaLogado() || SpinassiAPI.sessao.tokenExpirado()) {
    SpinassiAPI.sessao.limpar();
    window.location.href = 'index.html';
}

const usuario = SpinassiAPI.sessao.getUsuario();

/* ── Preenche sidebar ───────────────────────────────────── */
document.getElementById('sidebarAvatar').textContent =
    (usuario.nome || '?').charAt(0).toUpperCase();
document.getElementById('sidebarNome').textContent =
    `${usuario.nome || ''} ${usuario.sobrenome || ''}`.trim();
document.getElementById('sidebarEmail').textContent = usuario.email || '';

/* ── Carrega perfil da API ──────────────────────────────── */
async function carregarPerfil() {
    try {
        const res = await SpinassiAPI.auth.perfil();
        const p   = res.data;
        document.getElementById('fNome').value      = p.nome      || '';
        document.getElementById('fSobrenome').value = p.sobrenome || '';
        document.getElementById('fEmail').value     = p.email     || '';
        document.getElementById('fTelefone').value  = p.telefone  || '';
        document.getElementById('fNews').checked    = !!p.aceita_news;
        if (p.genero) document.getElementById('fGenero').value = p.genero;
    } catch (e) {
        showAlert('alertPerfil', 'Não foi possível carregar seus dados.', 'error');
    }
}

/* ── Salva perfil ───────────────────────────────────────── */
async function salvarPerfil(e) {
    e.preventDefault();
    const btn = document.getElementById('btnSalvarPerfil');
    btn.disabled = true;
    btn.querySelector('span').textContent = 'Salvando…';

    try {
        await SpinassiAPI.auth.atualizarPerfil({
            nome:       document.getElementById('fNome').value.trim(),
            sobrenome:  document.getElementById('fSobrenome').value.trim(),
            telefone:   document.getElementById('fTelefone').value.trim() || null,
            genero:     document.getElementById('fGenero').value || null,
            aceita_news: document.getElementById('fNews').checked,
        });
        showAlert('alertPerfil', 'Dados atualizados com sucesso!', 'success');
        /* Atualiza sessão local */
        const u = SpinassiAPI.sessao.getUsuario();
        u.nome      = document.getElementById('fNome').value.trim();
        u.sobrenome = document.getElementById('fSobrenome').value.trim();
        localStorage.setItem('sc_user', JSON.stringify(u));
        document.getElementById('sidebarNome').textContent = `${u.nome} ${u.sobrenome}`.trim();
        document.getElementById('sidebarAvatar').textContent = u.nome.charAt(0).toUpperCase();
    } catch (err) {
        showAlert('alertPerfil', err.message || 'Erro ao salvar.', 'error');
    } finally {
        btn.disabled = false;
        btn.querySelector('span').textContent = 'Salvar alterações';
    }
}

/* ── Altera senha ───────────────────────────────────────── */
async function alterarSenha(e) {
    e.preventDefault();
    const atual    = document.getElementById('fSenhaAtual').value;
    const nova     = document.getElementById('fNovaSenha').value;
    const confirma = document.getElementById('fConfirmaSenha').value;

    if (nova.length < 8) {
        showAlert('alertSenha', 'A nova senha deve ter ao menos 8 caracteres.', 'error');
        return;
    }
    if (nova !== confirma) {
        showAlert('alertSenha', 'As senhas não coincidem.', 'error');
        return;
    }

    const btn = document.getElementById('btnAlterarSenha');
    btn.disabled = true;
    btn.querySelector('span').textContent = 'Alterando…';

    try {
        await SpinassiAPI.auth.alterarSenha(atual, nova);
        showAlert('alertSenha', 'Senha alterada com sucesso!', 'success');
        document.getElementById('formSenha').reset();
        document.getElementById('strengthFill').style.width = '0%';
        document.getElementById('strengthText').textContent = 'Mínimo 8 caracteres';
    } catch (err) {
        showAlert('alertSenha', err.message || 'Erro ao alterar senha.', 'error');
    } finally {
        btn.disabled = false;
        btn.querySelector('span').textContent = 'Alterar senha';
    }
}

/* ── Helpers ────────────────────────────────────────────── */
function showAlert(id, msg, tipo) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.className   = `acc-alert show ${tipo}`;
    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    setTimeout(() => el.classList.remove('show'), 6000);
}

function toggleEye(inputId, iconId) {
    const input  = document.getElementById(inputId);
    const icon   = document.getElementById(iconId);
    const isPass = input.type === 'password';
    input.type   = isPass ? 'text' : 'password';
    icon.innerHTML = isPass
        ? `<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/>
           <path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/>
           <line x1="1" y1="1" x2="23" y2="23"/>`
        : `<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
           <circle cx="12" cy="12" r="3"/>`;
}

function calcStrength(v) {
    let s = 0;
    if (v.length >= 8) s++;
    if (/[A-Z]/.test(v)) s++;
    if (/[0-9]/.test(v)) s++;
    if (/[^A-Za-z0-9]/.test(v)) s++;
    const lvls = [
        { w:'0%',   bg:'#E0D8D0', t:'Mínimo 8 caracteres' },
        { w:'30%',  bg:'#E74C3C', t:'Fraca'       },
        { w:'55%',  bg:'#F39C12', t:'Média'       },
        { w:'80%',  bg:'#27AE60', t:'Forte'       },
        { w:'100%', bg:'#D4AF37', t:'Muito forte'  },
    ];
    const l = v.length ? lvls[s] : lvls[0];
    const fill = document.getElementById('strengthFill');
    fill.style.width      = v.length ? l.w  : '0%';
    fill.style.background = l.bg;
    document.getElementById('strengthText').textContent = v.length ? l.t : 'Mínimo 8 caracteres';
}

function scrollTo(id) {
    document.querySelector(id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function fazerLogout() {
    SpinassiAPI.auth.logout();
    window.location.href = 'index.html';
}

/* Inicia */
carregarPerfil();
</script>
</body>
</html>