<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos — Spinassi Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/conta.css">
</head>
<body>

<header class="acc-header">
    <a href="index.html" class="acc-logo">Spinassi <span>Chocolate</span></a>
    <a href="index.html" class="acc-back-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        Voltar à loja
    </a>
</header>

<div class="acc-layout">
    <aside class="acc-sidebar" id="sidebarMount"></aside>

    <main class="acc-main">
        <h1 class="acc-page-title">Produtos</h1>
        <p class="acc-page-subtitle" id="subtitleProd">Gerencie o catálogo de produtos</p>

        <!-- Toolbar -->
        <div class="adm-toolbar">
            <input class="adm-search" type="text" placeholder="Buscar produto…" id="searchProd" oninput="filtrarTabela()">
            <select class="adm-select" id="filterCat" onchange="filtrarTabela()">
                <option value="">Todas as categorias</option>
            </select>
            <select class="adm-select" id="filterAtivo" onchange="filtrarTabela()">
                <option value="">Todos os status</option>
                <option value="1">Ativos</option>
                <option value="0">Inativos</option>
            </select>
            <button class="btn-gold" onclick="abrirModal()"><span>+ Novo Produto</span></button>
        </div>

        <div class="acc-card">
            <div class="acc-card-body" style="padding:0">
                <div id="tabelaWrap">
                    <div class="acc-loading"><div class="spinner"></div> Carregando produtos…</div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- ── MODAL PRODUTO ───────────────────────────────────── -->
<div class="modal-overlay" id="modalProd">
    <div class="modal-box" style="max-width:760px">
        <div class="modal-header">
            <h3 id="modalTitulo">Novo Produto</h3>
            <button class="modal-close" onclick="fecharModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="acc-alert" id="modalAlert"></div>
            <form id="formProd" onsubmit="salvarProduto(event)">
                <div class="acc-form-grid">

                    <div class="acc-field full">
                        <label>Nome do produto *</label>
                        <input type="text" id="pNome" maxlength="150" required>
                    </div>

                    <div class="acc-field">
                        <label>Categoria</label>
                        <select id="pCategoria"></select>
                    </div>

                    <div class="acc-field">
                        <label>Badge (ex: Novo, Bestseller)</label>
                        <input type="text" id="pBadge" maxlength="50">
                    </div>

                    <div class="acc-field">
                        <label>Preço base (R$) *</label>
                        <input type="number" id="pPreco" step="0.01" min="0" required>
                    </div>

                    <div class="acc-field">
                        <label>Preço promocional (R$)</label>
                        <input type="number" id="pPrecoPromo" step="0.01" min="0">
                    </div>

                    <div class="acc-field">
                        <label>Estoque base (unidades)</label>
                        <input type="number" id="pEstoque" min="0" value="0">
                    </div>

                    <div class="acc-field">
                        <label>Peso base (gramas)</label>
                        <input type="number" id="pPeso" min="0">
                    </div>

                    <div class="acc-field full">
                        <label>URL da imagem principal</label>
                        <input type="url" id="pImagem" placeholder="https://…">
                    </div>

                    <div class="acc-field full">
                        <label>Descrição curta</label>
                        <input type="text" id="pDescCurta" maxlength="300">
                    </div>

                    <div class="acc-field full">
                        <label>Descrição completa</label>
                        <textarea id="pDesc" rows="4" style="resize:vertical"></textarea>
                    </div>

                    <div class="acc-field" style="display:flex;gap:24px;align-items:center;">
                        <label class="toggle-wrap">
                            <span class="toggle-label">Ativo</span>
                            <label class="toggle"><input type="checkbox" id="pAtivo" checked><span class="toggle-slider"></span></label>
                        </label>
                        <label class="toggle-wrap">
                            <span class="toggle-label">Destaque</span>
                            <label class="toggle"><input type="checkbox" id="pDestaque"><span class="toggle-slider"></span></label>
                        </label>
                    </div>

                </div>

                <!-- Sabores -->
                <div style="margin-top:28px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <h4 style="font-size:1rem;color:var(--chocolate-dark);">Sabores / Variações</h4>
                        <button type="button" class="btn-outline" style="font-size:.7rem;padding:7px 14px;"
                                onclick="addSaborRow()">+ Adicionar Sabor</button>
                    </div>
                    <div id="saboresWrap" style="display:flex;flex-direction:column;gap:10px;"></div>
                </div>

                <div style="margin-top:26px;display:flex;gap:12px;">
                    <button type="submit" class="btn-gold" id="btnSalvarProd"><span>Salvar Produto</span></button>
                    <button type="button" class="btn-outline" onclick="fecharModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ── MODAL CONFIRMAR EXCLUSÃO ───────────────────────── -->
<div class="modal-overlay" id="modalDel">
    <div class="modal-box" style="max-width:440px">
        <div class="modal-header">
            <h3>Excluir produto</h3>
            <button class="modal-close" onclick="fecharModalDel()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom:20px;font-size:.9rem;">
                Tem certeza que deseja desativar o produto <strong id="delNomeProd"></strong>?
                Ele não será exibido na loja, mas o histórico de pedidos será preservado.
            </p>
            <div style="display:flex;gap:12px;">
                <button class="btn-gold" style="background:var(--danger);color:#fff;" id="btnConfirmDel">
                    <span>Sim, desativar</span>
                </button>
                <button class="btn-outline" onclick="fecharModalDel()">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<script src="../assets/js/api.js"></script>
<script src="../assets/js/sidebar.js"></script>
<script>
/* ============================================================
   ADMIN PRODUTOS
============================================================ */

/* ── Guard admin ─────────────────────────────────────────── */
(function(){
    const u = SpinassiAPI.sessao.getUsuario();
    if (!SpinassiAPI.sessao.estaLogado() || SpinassiAPI.sessao.tokenExpirado() || u?.tipo !== 'admin') {
        SpinassiAPI.sessao.limpar();
        window.location.href = 'index.html';
    }
})();
renderSidebar('admin-produtos');

/* ── Estado ──────────────────────────────────────────────── */
let todosOsProdutos = [];
let categorias      = [];
let editandoId      = null;
let deletandoId     = null;
let saborIdx        = 0;

/* ── Formata moeda ───────────────────────────────────────── */
const fmt = v => 'R$ ' + parseFloat(v || 0).toFixed(2).replace('.', ',');

/* ── Init ────────────────────────────────────────────────── */
async function init() {
    await Promise.all([carregarCategorias(), carregarProdutos()]);
}

/* ── Categorias ──────────────────────────────────────────── */
async function carregarCategorias() {
    try {
        const res = await SpinassiAPI.get('/api/categorias');
        categorias = res.data || [];
        const sel1 = document.getElementById('filterCat');
        const sel2 = document.getElementById('pCategoria');
        categorias.forEach(c => {
            sel1.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.nome}</option>`);
            sel2.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.nome}</option>`);
        });
    } catch(e) { console.error(e); }
}

/* ── Carrega produtos ────────────────────────────────────── */
async function carregarProdutos() {
    try {
        const res = await SpinassiAPI.get('/api/admin/produtos', true);
        todosOsProdutos = res.data || [];
        document.getElementById('subtitleProd').textContent =
            `${todosOsProdutos.length} produto(s) cadastrado(s)`;
        renderTabela(todosOsProdutos);
    } catch(e) {
        document.getElementById('tabelaWrap').innerHTML =
            `<p style="padding:20px;color:var(--danger);">Erro: ${e.message}</p>`;
    }
}

/* ── Renderiza tabela ────────────────────────────────────── */
function renderTabela(prods) {
    if (!prods.length) {
        document.getElementById('tabelaWrap').innerHTML =
            `<div class="acc-empty" style="padding:60px">
                <h3>Nenhum produto encontrado</h3>
                <p>Tente outro filtro ou crie um novo produto.</p>
            </div>`;
        return;
    }
    document.getElementById('tabelaWrap').innerHTML = `
        <div class="adm-table-wrap">
        <table class="adm-table">
            <thead>
                <tr>
                    <th>Imagem</th>
                    <th>Nome</th>
                    <th>Categoria</th>
                    <th>Preço</th>
                    <th>Estoque</th>
                    <th>Peso</th>
                    <th>Status</th>
                    <th>Destaque</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                ${prods.map(p => `
                <tr>
                    <td><img src="${p.imagem_principal || 'https://images.unsplash.com/photo-1548907040-4baa42d10919?w=100'}"
                             onerror="this.src='https://images.unsplash.com/photo-1548907040-4baa42d10919?w=100'"></td>
                    <td>
                        <strong>${p.nome}</strong>
                        ${p.badge ? `<br><small style="color:var(--gold);font-size:.65rem">${p.badge}</small>` : ''}
                    </td>
                    <td>${p.categoria_nome || '—'}</td>
                    <td>
                        ${fmt(p.preco)}
                        ${p.preco_promocional ? `<br><small style="color:var(--success);font-size:.72rem">${fmt(p.preco_promocional)}</small>` : ''}
                    </td>
                    <td>${p.estoque ?? '—'}</td>
                    <td>${p.peso_gramas ? p.peso_gramas+'g' : '—'}</td>
                    <td><span class="prod-status prod-status--${p.ativo?'ativo':'inativo'}">${p.ativo?'Ativo':'Inativo'}</span></td>
                    <td>${p.destaque ? '⭐' : '—'}</td>
                    <td>
                        <div class="adm-actions">
                            <button class="btn-icon btn-icon--edit" onclick="editarProduto(${p.id})" title="Editar">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="btn-icon btn-icon--del" onclick="confirmarDeletar(${p.id},'${p.nome.replace(/'/g,"\\'")}')" title="Desativar">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                                    <path d="M10 11v6M14 11v6"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
        </div>`;
}

/* ── Filtro ──────────────────────────────────────────────── */
function filtrarTabela() {
    const busca = document.getElementById('searchProd').value.toLowerCase();
    const cat   = document.getElementById('filterCat').value;
    const ativo = document.getElementById('filterAtivo').value;
    const filtrado = todosOsProdutos.filter(p => {
        const matchBusca = p.nome.toLowerCase().includes(busca) ||
                           (p.descricao_curta||'').toLowerCase().includes(busca);
        const matchCat   = !cat   || String(p.categoria_id) === cat;
        const matchAtivo = ativo === '' || String(p.ativo)  === ativo;
        return matchBusca && matchCat && matchAtivo;
    });
    renderTabela(filtrado);
}

/* ── Modal produto ───────────────────────────────────────── */
function abrirModal(prod = null) {
    editandoId = prod ? prod.id : null;
    document.getElementById('modalTitulo').textContent = prod ? 'Editar Produto' : 'Novo Produto';
    document.getElementById('modalAlert').className = 'acc-alert';

    // Reset form
    document.getElementById('formProd').reset();
    document.getElementById('saboresWrap').innerHTML = '';
    saborIdx = 0;

    if (prod) {
        document.getElementById('pNome').value      = prod.nome      || '';
        document.getElementById('pBadge').value     = prod.badge     || '';
        document.getElementById('pPreco').value     = prod.preco     || '';
        document.getElementById('pPrecoPromo').value= prod.preco_promocional || '';
        document.getElementById('pEstoque').value   = prod.estoque   ?? 0;
        document.getElementById('pPeso').value      = prod.peso_gramas || '';
        document.getElementById('pImagem').value    = prod.imagem_principal || '';
        document.getElementById('pDescCurta').value = prod.descricao_curta || '';
        document.getElementById('pDesc').value      = prod.descricao || '';
        document.getElementById('pAtivo').checked   = !!prod.ativo;
        document.getElementById('pDestaque').checked= !!prod.destaque;
        if (prod.categoria_id) document.getElementById('pCategoria').value = prod.categoria_id;
        // Carrega sabores existentes
        carregarSaboresProduto(prod.id);
    }

    document.getElementById('modalProd').classList.add('open');
    document.body.style.overflow = 'hidden';
}

async function carregarSaboresProduto(pid) {
    try {
        const res = await SpinassiAPI.get(`/api/admin/produtos/${pid}/sabores`, true);
        (res.data || []).forEach(s => addSaborRow(s));
    } catch(e) { /* produto novo ou sem sabores */ }
}

function fecharModal() {
    document.getElementById('modalProd').classList.remove('open');
    document.body.style.overflow = '';
    editandoId = null;
}

/* ── Row de sabor ────────────────────────────────────────── */
function addSaborRow(s = null) {
    const idx = saborIdx++;
    const id  = s ? `data-sabor-id="${s.id}"` : '';
    document.getElementById('saboresWrap').insertAdjacentHTML('beforeend', `
        <div class="sabor-row" ${id} style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:8px;align-items:end;">
            <div class="acc-field" style="margin:0">
                <label>Nome do sabor</label>
                <input type="text" class="sabor-nome" value="${s?.nome||''}" placeholder="Ex: Framboesa" maxlength="100">
            </div>
            <div class="acc-field" style="margin:0">
                <label>Preço adic. R$</label>
                <input type="number" class="sabor-preco" value="${s?.preco_adicional||0}" step="0.01" min="0">
            </div>
            <div class="acc-field" style="margin:0">
                <label>Peso (g)</label>
                <input type="number" class="sabor-peso" value="${s?.peso_gramas||''}" min="0">
            </div>
            <div class="acc-field" style="margin:0">
                <label>Estoque</label>
                <input type="number" class="sabor-estoque" value="${s?.estoque||0}" min="0">
            </div>
            <button type="button" class="btn-icon btn-icon--del" style="margin-bottom:0;width:36px;height:36px;"
                    onclick="this.closest('.sabor-row').remove()" title="Remover sabor">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>`);
}

/* ── Salva produto ───────────────────────────────────────── */
async function salvarProduto(e) {
    e.preventDefault();
    const btn = document.getElementById('btnSalvarProd');
    btn.disabled = true;
    btn.querySelector('span').textContent = 'Salvando…';

    const nome = document.getElementById('pNome').value.trim();
    const slug = nome.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-');

    const payload = {
        nome,
        slug,
        categoria_id:     document.getElementById('pCategoria').value || null,
        badge:            document.getElementById('pBadge').value.trim() || null,
        preco:            parseFloat(document.getElementById('pPreco').value),
        preco_promocional:parseFloat(document.getElementById('pPrecoPromo').value)||null,
        estoque:          parseInt(document.getElementById('pEstoque').value)||0,
        peso_gramas:      parseInt(document.getElementById('pPeso').value)||null,
        imagem_principal: document.getElementById('pImagem').value.trim()||null,
        descricao_curta:  document.getElementById('pDescCurta').value.trim()||null,
        descricao:        document.getElementById('pDesc').value.trim()||null,
        ativo:            document.getElementById('pAtivo').checked,
        destaque:         document.getElementById('pDestaque').checked,
    };

    // Coleta sabores
    const sabores = [];
    document.querySelectorAll('.sabor-row').forEach(row => {
        const nome = row.querySelector('.sabor-nome').value.trim();
        if (!nome) return;
        sabores.push({
            id:             row.dataset.saborId ? parseInt(row.dataset.saborId) : null,
            nome,
            preco_adicional:parseFloat(row.querySelector('.sabor-preco').value)||0,
            peso_gramas:    parseInt(row.querySelector('.sabor-peso').value)||null,
            estoque:        parseInt(row.querySelector('.sabor-estoque').value)||0,
        });
    });
    payload.sabores = sabores;

    try {
        if (editandoId) {
            await SpinassiAPI.put(`/api/admin/produtos/${editandoId}`, payload, true);
        } else {
            await SpinassiAPI.post('/api/admin/produtos', payload, true);
        }
        fecharModal();
        await carregarProdutos();
    } catch(err) {
        const al = document.getElementById('modalAlert');
        al.textContent = err.message || 'Erro ao salvar produto.';
        al.className   = 'acc-alert show error';
    } finally {
        btn.disabled = false;
        btn.querySelector('span').textContent = 'Salvar Produto';
    }
}

/* ── Editar ──────────────────────────────────────────────── */
async function editarProduto(id) {
    const prod = todosOsProdutos.find(p => p.id === id);
    if (prod) abrirModal(prod);
}

/* ── Deletar ─────────────────────────────────────────────── */
function confirmarDeletar(id, nome) {
    deletandoId = id;
    document.getElementById('delNomeProd').textContent = nome;
    document.getElementById('modalDel').classList.add('open');
    document.body.style.overflow = 'hidden';
    document.getElementById('btnConfirmDel').onclick = async () => {
        document.getElementById('btnConfirmDel').querySelector('span').textContent = 'Desativando…';
        try {
            await SpinassiAPI.delete(`/api/admin/produtos/${deletandoId}`, true);
            fecharModalDel();
            await carregarProdutos();
        } catch(err) { alert(err.message); }
    };
}
function fecharModalDel() {
    document.getElementById('modalDel').classList.remove('open');
    document.body.style.overflow = '';
    deletandoId = null;
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') { fecharModal(); fecharModalDel(); } });
document.getElementById('modalProd').addEventListener('click', e => { if(e.target===e.currentTarget) fecharModal(); });
document.getElementById('modalDel').addEventListener('click',  e => { if(e.target===e.currentTarget) fecharModalDel(); });

init();
</script>
</body>
</html>