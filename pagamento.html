<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Pedido - Spinassi Chocolates</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/pagamento.css">
</head>
<body>

<!-- ========== WHATSAPP FLUTUANTE ========== -->
<a href="https://wa.me/5583999999999?text=Ol√°! Gostaria de fazer um pedido."
   class="whatsapp-float" target="_blank" aria-label="WhatsApp">
    <svg viewBox="0 0 32 32">
        <defs>
            <linearGradient id="gWA" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%"   stop-color="#FFD700"/>
                <stop offset="30%"  stop-color="#FFF8DC"/>
                <stop offset="50%"  stop-color="#FFFFFF"/>
                <stop offset="70%"  stop-color="#D4AF37"/>
                <stop offset="100%" stop-color="#FFD700"/>
            </linearGradient>
        </defs>
        <path fill="url(#gWA)" d="M16 0C7.164 0 0 7.163 0 16c0 2.816.736 5.464 2.025 7.76L0 32l8.448-2.218A15.93 15.93 0 0016 32c8.837 0 16-7.163 16-16S24.837 0 16 0zm0 29.455c-2.513 0-4.88-.69-6.91-1.895l-.496-.296-5.145 1.35 1.374-5.022-.324-.513A13.413 13.413 0 012.545 16c0-7.424 6.03-13.455 13.455-13.455S29.455 8.576 29.455 16 23.424 29.455 16 29.455zm7.394-10.096c-.406-.203-2.397-1.183-2.77-1.318-.372-.135-.642-.203-.913.203-.27.406-1.048 1.318-1.285 1.589-.237.27-.473.304-.88.101-.406-.203-1.713-.631-3.263-2.013-1.206-1.075-2.02-2.402-2.257-2.809-.237-.406-.025-.626.178-.828.183-.183.406-.473.61-.71.203-.237.27-.406.406-.677.135-.27.068-.507-.034-.71-.101-.203-.913-2.2-1.251-3.014-.33-.793-.666-.686-.913-.699-.237-.012-.507-.015-.777-.015s-.71.101-1.082.507c-.372.406-1.42 1.386-1.42 3.383s1.453 3.924 1.656 4.194c.203.27 2.858 4.366 6.927 6.123.968.418 1.724.668 2.313.855.972.309 1.856.265 2.555.161.78-.116 2.397-.98 2.735-1.927.338-.946.338-1.758.237-1.927-.101-.169-.372-.27-.78-.473z"/>
    </svg>
</a>

<!-- ========== HEADER ========== -->
<header class="header">
    <nav class="nav-container">
        <div class="logo">
            <h1>Spinassi <span>Chocolate</span></h1>
        </div>
        <a href="index.html" class="nav-back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Voltar √† loja
        </a>
    </nav>
</header>

<!-- ========== HERO ========== -->
<section class="page-hero">
    <div class="page-hero-inner">
        <span class="subtitle">Experi√™ncia Premium</span>
        <h2>Finalizar Pedido</h2>
    </div>
    <svg class="drip-bar" viewBox="0 0 1440 60" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
        <path fill="#FFF8E7" d="M0,20 C120,55 240,0 360,35 C480,60 600,10 720,40 C840,60 960,15 1080,45 C1200,60 1320,20 1440,30 L1440,60 L0,60 Z"/>
    </svg>
</section>

<!-- ========== BARRA DE PROGRESSO ========== -->
<div class="steps-bar">
    <div class="steps">
        <div class="step done">
            <div class="step-num">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <span class="step-label">Carrinho</span>
        </div>
        <div class="step-line"></div>
        <div class="step active">
            <div class="step-num">2</div>
            <span class="step-label">Pagamento</span>
        </div>
        <div class="step-line step-line--dim"></div>
        <div class="step">
            <div class="step-num">3</div>
            <span class="step-label">Confirma√ß√£o</span>
        </div>
    </div>
</div>

<!-- ========== LAYOUT PRINCIPAL ========== -->
<div class="checkout-layout">

    <!-- ===== COLUNA FORMUL√ÅRIO ===== -->
    <div class="checkout-form-area">

        <!-- DADOS PESSOAIS -->
        <div class="form-section">
            <h3 class="form-section-title">
                <span class="icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </span>
                Dados Pessoais
            </h3>
            <div class="form-row">
                <div class="form-group" id="fg-nome">
                    <input type="text" id="nome" placeholder=" " autocomplete="given-name">
                    <label for="nome">Nome completo *</label>
                    <span class="field-error">Por favor, informe seu nome</span>
                </div>
                <div class="form-group" id="fg-email">
                    <input type="email" id="email" placeholder=" " autocomplete="email">
                    <label for="email">E-mail *</label>
                    <span class="field-error">E-mail inv√°lido</span>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" id="fg-cpf">
                    <input type="text" id="cpf" placeholder=" " maxlength="14">
                    <label for="cpf">CPF *</label>
                    <span class="field-error">CPF inv√°lido</span>
                </div>
                <div class="form-group">
                    <input type="tel" id="telefone" placeholder=" " autocomplete="tel">
                    <label for="telefone">Telefone</label>
                </div>
            </div>
        </div>

        <!-- ENDERE√áO DE ENTREGA -->
        <div class="form-section">
            <h3 class="form-section-title">
                <span class="icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                </span>
                Endere√ßo de Entrega
            </h3>
            <div class="form-row">
                <div class="form-group" id="fg-cep">
                    <input type="text" id="cep" placeholder=" " maxlength="9">
                    <label for="cep">CEP *</label>
                    <span class="field-error">CEP inv√°lido</span>
                </div>
                <div class="form-group">
                    <select id="estado">
                        <option value="" disabled selected></option>
                        <option>AC</option><option>AL</option><option>AP</option><option>AM</option>
                        <option>BA</option><option>CE</option><option>DF</option><option>ES</option>
                        <option>GO</option><option>MA</option><option>MT</option><option>MS</option>
                        <option>MG</option><option>PA</option><option>PB</option><option>PR</option>
                        <option>PE</option><option>PI</option><option>RJ</option><option>RN</option>
                        <option>RS</option><option>RO</option><option>RR</option><option>SC</option>
                        <option>SP</option><option>SE</option><option>TO</option>
                    </select>
                    <label for="estado">Estado *</label>
                </div>
            </div>
            <div class="form-row single">
                <div class="form-group" id="fg-rua">
                    <input type="text" id="rua" placeholder=" " autocomplete="street-address">
                    <label for="rua">Rua / Avenida *</label>
                    <span class="field-error">Por favor, informe o endere√ßo</span>
                </div>
            </div>
            <div class="form-row triple">
                <div class="form-group">
                    <input type="text" id="cidade" placeholder=" " autocomplete="address-level2">
                    <label for="cidade">Cidade *</label>
                </div>
                <div class="form-group">
                    <input type="text" id="numero" placeholder=" ">
                    <label for="numero">N√∫mero *</label>
                </div>
                <div class="form-group">
                    <input type="text" id="complemento" placeholder=" ">
                    <label for="complemento">Complemento</label>
                </div>
            </div>
        </div>

        <!-- FORMA DE PAGAMENTO -->
        <div class="form-section">
            <h3 class="form-section-title">
                <span class="icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2"/>
                        <line x1="1" y1="10" x2="23" y2="10"/>
                    </svg>
                </span>
                Forma de Pagamento
            </h3>

            <div class="payment-methods">
                <button class="payment-method-btn active" onclick="selectMethod('card', this)">
                    <svg class="method-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2"/>
                        <line x1="1" y1="10" x2="23" y2="10"/>
                    </svg>
                    Cart√£o
                </button>
                <button class="payment-method-btn" onclick="selectMethod('pix', this)">
                    <svg class="method-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="13 17 18 12 13 7"/>
                        <polyline points="6 17 11 12 6 7"/>
                    </svg>
                    Pix
                </button>
                <button class="payment-method-btn" onclick="selectMethod('boleto', this)">
                    <svg class="method-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="8" y1="13" x2="16" y2="13"/>
                        <line x1="8" y1="17" x2="16" y2="17"/>
                    </svg>
                    Boleto
                </button>
            </div>

            <!-- PAINEL: CART√ÉO -->
            <div class="payment-panel active" id="panel-card">
                <div class="card-visual">
                    <div class="card-chip"></div>
                    <div class="card-number-preview" id="cardNumPreview">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                    <div class="card-bottom">
                        <div>
                            <div class="card-label">Titular</div>
                            <div class="card-value" id="cardNamePreview">SEU NOME</div>
                        </div>
                        <div>
                            <div class="card-label">Validade</div>
                            <div class="card-value" id="cardExpPreview">MM/AA</div>
                        </div>
                    </div>
                </div>
                <div class="form-row single">
                    <div class="form-group" id="fg-cardnum">
                        <input type="text" id="cardNum" placeholder=" " maxlength="19">
                        <label for="cardNum">N√∫mero do Cart√£o *</label>
                        <span class="field-error">N√∫mero de cart√£o inv√°lido</span>
                    </div>
                </div>
                <div class="form-row single">
                    <div class="form-group">
                        <input type="text" id="cardName" placeholder=" " class="input-uppercase">
                        <label for="cardName">Nome impresso no cart√£o *</label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" id="fg-cardexp">
                        <input type="text" id="cardExp" placeholder=" " maxlength="5">
                        <label for="cardExp">Validade (MM/AA) *</label>
                        <span class="field-error">Data inv√°lida</span>
                    </div>
                    <div class="form-group" id="fg-cardcvv">
                        <input type="text" id="cardCvv" placeholder=" " maxlength="4">
                        <label for="cardCvv">CVV *</label>
                        <span class="field-error">CVV inv√°lido</span>
                    </div>
                </div>
                <div class="form-row single">
                    <div class="form-group">
                        <select id="parcelas">
                            <option value="1">1x sem juros</option>
                            <option value="2">2x sem juros</option>
                            <option value="3">3x sem juros</option>
                            <option value="6">6x sem juros</option>
                            <option value="12">12x com juros</option>
                        </select>
                        <label for="parcelas" class="label-static">Parcelamento</label>
                    </div>
                </div>
            </div>

            <!-- PAINEL: PIX -->
            <div class="payment-panel" id="panel-pix">
                <div class="pix-display">
                    <p class="pix-intro">
                        Escaneie o QR Code ou copie o c√≥digo para pagar. O pagamento √© confirmado instantaneamente.
                    </p>
                    <div class="pix-qr">
                        <div class="pix-qr-pattern" id="qrPattern"></div>
                    </div>
                    <div class="pix-code" id="pixCode" onclick="copyPix()" title="Clique para copiar">
                        00020126580014BR.GOV.BCB.PIX0136spinassi@chocolates.com.br5204000053039865802BR5920Spinassi Chocolates6009SAO PAULO62070503***6304ABCD
                    </div>
                    <p class="pix-copy-hint">üëÜ Clique para copiar o c√≥digo</p>
                    <div class="pix-timer">
                        Expira em: <span id="pixTimerDisplay">15:00</span>
                    </div>
                </div>
            </div>

            <!-- PAINEL: BOLETO -->
            <div class="payment-panel" id="panel-boleto">
                <div class="boleto-display">
                    <div class="boleto-info">
                        <p>‚è≥ O boleto vence em <strong>3 dias √∫teis</strong> ap√≥s a emiss√£o.</p>
                        <p>üì¶ O pedido ser√° processado ap√≥s a confirma√ß√£o do pagamento.</p>
                        <p>üí∞ Pagamento em qualquer banco, lot√©rica ou app banc√°rio.</p>
                    </div>
                    <div class="boleto-barcode">
                        <div class="barcode-lines" id="barcodeLines"></div>
                        <p class="boleto-code-text">1234.5678 9012.3456 7890.1234 5 67890000000000</p>
                    </div>
                    <button class="btn-boleto-download" onclick="downloadBoleto()">
                        ‚¨á Baixar Boleto
                    </button>
                </div>
            </div>

        </div><!-- /form-section pagamento -->

        <button class="btn-pay" id="btnPagar" onclick="processarPagamento()">
            <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <rect x="3" y="11" width="18" height="11" rx="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            Confirmar Pagamento
        </button>

    </div><!-- /checkout-form-area -->

    <!-- ===== COLUNA RESUMO ===== -->
    <aside class="order-summary">
        <div class="summary-card">

            <div class="summary-header">
                <h3>Resumo do Pedido</h3>
                <div class="order-id">Pedido #SC-<span id="orderNum">------</span></div>
            </div>

            <div class="summary-items" id="summaryItems"></div>

            <div class="summary-totals">
                <div class="total-line">
                    <span>Subtotal</span>
                    <span id="subtotalDisplay">R$ 0,00</span>
                </div>
                <div class="total-line">
                    <span>Frete</span>
                    <span id="freteDisplay" class="shipping-value">Gr√°tis</span>
                </div>
                <div class="total-line total-line--discount" id="descontoLine">
                    <span>Desconto</span>
                    <span id="descontoDisplay">-R$ 0,00</span>
                </div>
                <div class="total-divider"></div>
                <div class="total-final">
                    <span class="label">Total</span>
                    <span class="value" id="totalDisplay">R$ 0,00</span>
                </div>
                <div class="total-installments" id="installmentsDisplay"></div>
            </div>

            <!-- Cupom -->
            <div class="cupom-area">
                <div class="cupom-row">
                    <div class="form-group cupom-group">
                        <input type="text" id="cupomInput" placeholder=" ">
                        <label for="cupomInput">Cupom de desconto</label>
                    </div>
                    <button class="btn-cupom" onclick="aplicarCupom()">Aplicar</button>
                </div>
                <p id="cupomMsg" class="cupom-msg"></p>
            </div>

            <div class="summary-benefits">
                <div class="benefit-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="3" width="15" height="13"/>
                        <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                        <circle cx="5.5" cy="18.5" r="2.5"/>
                        <circle cx="18.5" cy="18.5" r="2.5"/>
                    </svg>
                    Entrega para todo o Brasil
                </div>
                <div class="benefit-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                        <polyline points="17 6 23 6 23 12"/>
                    </svg>
                    Frete gr√°tis acima de R$ 150
                </div>
                <div class="benefit-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    Compra 100% segura e protegida
                </div>
            </div>

            <div class="security-badges">
                <div class="badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    SSL
                </div>
                <div class="badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Pago Seguro
                </div>
                <div class="badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    24h/7
                </div>
            </div>

        </div>
    </aside>

</div><!-- /checkout-layout -->

<!-- ========== FOOTER ========== -->
<footer class="footer">
    <div class="container">
        <p>&copy; 2024 Spinassi Chocolates. Todos os direitos reservados. Pagamento seguro com criptografia SSL.</p>
    </div>
</footer>

<!-- ========== OVERLAY DE SUCESSO ========== -->
<div class="success-overlay" id="successOverlay">
    <div class="success-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="20 6 9 17 4 12"/>
        </svg>
    </div>
    <h2>Pedido Confirmado!</h2>
    <p>Obrigado pela sua compra. Voc√™ receber√° um e-mail com os detalhes do pedido em instantes.</p>
    <p>Nossa equipe j√° est√° preparando seu chocolate com todo o carinho üç´</p>
    <div class="success-order-id">Pedido #SC-<span id="successOrderNum"></span> confirmado</div>
    <a href="index.html" class="btn-success-home">Continuar Comprando</a>
</div>

<!-- ========== JAVASCRIPT ========== -->
<script>
    /* -------------------------------------------------------
       1. CARRINHO
    ------------------------------------------------------- */
    const carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
    let currentMethod = 'card';
    let pixInterval   = null;
    let pixSeconds    = 900;

    if (carrinho.length === 0) {
        const demo = [
            { id: 1, nome: 'Trufa Belga Premium',  preco: 89.90,  quantidade: 2,
              imagem: 'https://images.unsplash.com/photo-1548907040-4baa42d10919?w=200' },
            { id: 3, nome: 'Bombons Sortidos Luxo', preco: 129.90, quantidade: 1,
              imagem: 'https://images.unsplash.com/photo-1606312619070-d48b4f0c1b2d?w=200' }
        ];
        demo.forEach(i => carrinho.push(i));
    }

    /* -------------------------------------------------------
       2. RESUMO DO PEDIDO
    ------------------------------------------------------- */
    function renderSummary() {
        const container = document.getElementById('summaryItems');
        container.innerHTML = carrinho.map(item => `
            <div class="summary-item">
                <img src="${item.imagem}" alt="${item.nome}" class="summary-item-img">
                <div class="summary-item-info">
                    <div class="summary-item-name">${item.nome}</div>
                    <div class="summary-item-qty">${item.quantidade}x R$ ${item.preco.toFixed(2).replace('.', ',')}</div>
                </div>
                <div class="summary-item-price">R$ ${(item.preco * item.quantidade).toFixed(2).replace('.', ',')}</div>
            </div>
        `).join('');
        recalcularTotais();
    }

    let desconto = 0;

    function recalcularTotais() {
        const subtotal = carrinho.reduce((s, i) => s + i.preco * i.quantidade, 0);
        const frete    = subtotal >= 150 ? 0 : 19.90;
        const total    = subtotal - desconto + frete;

        document.getElementById('subtotalDisplay').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
        document.getElementById('freteDisplay').textContent    = frete === 0 ? 'Gr√°tis' : `R$ ${frete.toFixed(2).replace('.', ',')}`;
        document.getElementById('totalDisplay').textContent    = `R$ ${total.toFixed(2).replace('.', ',')}`;

        const parc   = parseInt(document.getElementById('parcelas')?.value || 1);
        const parcEl = document.getElementById('installmentsDisplay');
        if (currentMethod === 'card' && parc > 1) {
            parcEl.textContent    = `${parc}x de R$ ${(total / parc).toFixed(2).replace('.', ',')}`;
            parcEl.style.display  = 'block';
        } else {
            parcEl.style.display  = 'none';
        }

        const descontoLine = document.getElementById('descontoLine');
        if (desconto > 0) {
            descontoLine.style.display = 'flex';
            document.getElementById('descontoDisplay').textContent = `-R$ ${desconto.toFixed(2).replace('.', ',')}`;
        } else {
            descontoLine.style.display = 'none';
        }
    }

    const orderNum = Math.floor(Math.random() * 900000 + 100000);
    document.getElementById('orderNum').textContent        = orderNum;
    document.getElementById('successOrderNum').textContent = orderNum;

    /* -------------------------------------------------------
       3. SELE√á√ÉO DE M√âTODO
    ------------------------------------------------------- */
    function selectMethod(method, btn) {
        currentMethod = method;
        document.querySelectorAll('.payment-method-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.payment-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('panel-' + method).classList.add('active');
        if (method === 'pix') startPixTimer();
        else stopPixTimer();
        recalcularTotais();
    }

    /* -------------------------------------------------------
       4. PREVIEW CART√ÉO
    ------------------------------------------------------- */
    document.getElementById('cardNum').addEventListener('input', function () {
        let v = this.value.replace(/\D/g, '').substring(0, 16);
        v = v.replace(/(.{4})/g, '$1 ').trim();
        this.value = v;
        document.getElementById('cardNumPreview').textContent =
            v.length >= 4 ? v.padEnd(19, '\u2022') : '\u2022\u2022\u2022\u2022 \u2022\u2022\u2022\u2022 \u2022\u2022\u2022\u2022 \u2022\u2022\u2022\u2022';
    });
    document.getElementById('cardName').addEventListener('input', function () {
        document.getElementById('cardNamePreview').textContent = this.value.toUpperCase() || 'SEU NOME';
    });
    document.getElementById('cardExp').addEventListener('input', function () {
        let v = this.value.replace(/\D/g, '');
        if (v.length > 2) v = v.substring(0, 2) + '/' + v.substring(2, 4);
        this.value = v;
        document.getElementById('cardExpPreview').textContent = v || 'MM/AA';
    });
    document.getElementById('cardCvv').addEventListener('input', function () {
        this.value = this.value.replace(/\D/g, '');
    });
    document.getElementById('cpf').addEventListener('input', function () {
        let v = this.value.replace(/\D/g, '');
        if (v.length > 3)  v = v.substring(0, 3)  + '.' + v.substring(3);
        if (v.length > 7)  v = v.substring(0, 7)  + '.' + v.substring(7);
        if (v.length > 11) v = v.substring(0, 11) + '-' + v.substring(11, 13);
        this.value = v.substring(0, 14);
    });
    document.getElementById('cep').addEventListener('input', function () {
        let v = this.value.replace(/\D/g, '');
        if (v.length > 5) v = v.substring(0, 5) + '-' + v.substring(5, 8);
        this.value = v;
    });
    document.getElementById('telefone').addEventListener('input', function () {
        let v = this.value.replace(/\D/g, '');
        if (v.length > 0)  v = '(' + v;
        if (v.length > 3)  v = v.substring(0, 3) + ') ' + v.substring(3);
        if (v.length > 10) v = v.substring(0, 10) + '-' + v.substring(10, 15);
        this.value = v;
    });
    document.getElementById('parcelas').addEventListener('change', recalcularTotais);

    /* -------------------------------------------------------
       5. TIMER PIX
    ------------------------------------------------------- */
    function startPixTimer() {
        stopPixTimer();
        pixSeconds = 900;
        updatePixTimer();
        pixInterval = setInterval(() => { pixSeconds--; updatePixTimer(); if (pixSeconds <= 0) stopPixTimer(); }, 1000);
    }
    function stopPixTimer() { if (pixInterval) clearInterval(pixInterval); }
    function updatePixTimer() {
        const m = Math.floor(pixSeconds / 60);
        const s = pixSeconds % 60;
        document.getElementById('pixTimerDisplay').textContent =
            `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }
    function copyPix() {
        navigator.clipboard.writeText(document.getElementById('pixCode').textContent.trim())
            .then(() => showToast('C√≥digo Pix copiado!', 'success'))
            .catch(() => showToast('N√£o foi poss√≠vel copiar automaticamente.', 'error'));
    }
    function downloadBoleto() { showToast('Boleto gerado! O download iniciar√° em breve.', 'success'); }

    /* -------------------------------------------------------
       6. QR CODE DECORATIVO
    ------------------------------------------------------- */
    function generateQR() {
        const el = document.getElementById('qrPattern');
        if (!el) return;
        const fixedOn = new Set(['0,0','1,0','2,0','3,0','4,0','5,0','6,0','0,1','6,1','0,2','6,2',
            '0,3','6,3','0,4','6,4','0,5','6,5','0,6','1,6','2,6','3,6','4,6','5,6','6,6',
            '0,7','0,8','0,9','0,10','0,11','0,12','1,12','2,12','3,12','4,12','5,12','6,12',
            '6,7','6,8','6,9','6,10','6,11','1,8','2,8','3,8','4,8','1,9','2,9','3,9','4,9',
            '1,10','2,10','3,10','4,10','1,11','2,11','3,11','4,11']);
        let html = '';
        for (let r = 0; r < 13; r++)
            for (let c = 0; c < 13; c++)
                html += `<span style="opacity:${fixedOn.has(`${c},${r}`) || Math.random() > 0.5 ? 1 : 0}"></span>`;
        el.style.gridTemplateColumns = 'repeat(13, 1fr)';
        el.innerHTML = html;
    }

    /* -------------------------------------------------------
       7. C√ìDIGO DE BARRAS DECORATIVO
    ------------------------------------------------------- */
    function generateBarcode() {
        const el = document.getElementById('barcodeLines');
        if (!el) return;
        [1,2,1,3,1,2,3,1,2,1,3,2,1,1,3,2,1,3,2,1,2,1,3,1,2,1,2,3,1,3,2,1,2,1,3,2,1,3,1,2,
         1,3,2,1,1,3,2,1,3,1,2,3,1,2,1,3,1,2,1,3].forEach((w, i) => {
            const bar = document.createElement('span');
            bar.style.width   = (w * 2) + 'px';
            bar.style.opacity = i % 2 === 0 ? '1' : '0';
            el.appendChild(bar);
        });
    }

    /* -------------------------------------------------------
       8. CUPOM
    ------------------------------------------------------- */
    const cupons = { 'CHOCOLATE10': 10, 'NOIR20': 20, 'NOIR2024': 15 };
    function aplicarCupom() {
        const code = document.getElementById('cupomInput').value.trim().toUpperCase();
        const msg  = document.getElementById('cupomMsg');
        if (cupons[code]) {
            desconto = cupons[code];
            msg.textContent = `\u2713 Cupom aplicado: ${desconto}% de desconto!`;
            msg.className   = 'cupom-msg cupom-msg--success';
        } else {
            msg.textContent = '\u2717 Cupom inv\u00e1lido ou expirado.';
            msg.className   = 'cupom-msg cupom-msg--error';
            desconto = 0;
        }
        msg.style.display = 'block';
        recalcularTotais();
    }

    /* -------------------------------------------------------
       9. VALIDA√á√ÉO E PROCESSAMENTO
    ------------------------------------------------------- */
    function validateField(id, ok) {
        const fg = document.getElementById('fg-' + id);
        if (!fg) return true;
        fg.classList.toggle('error', !ok);
        return ok;
    }

    function processarPagamento() {
        const nome  = document.getElementById('nome').value.trim();
        const email = document.getElementById('email').value.trim();
        const cpf   = document.getElementById('cpf').value.trim();
        const rua   = document.getElementById('rua').value.trim();
        const cep   = document.getElementById('cep').value.trim();
        let valid   = true;

        valid = validateField('nome',  nome.length >= 3)                        && valid;
        valid = validateField('email', /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) && valid;
        valid = validateField('cpf',   /^\d{3}\.\d{3}\.\d{3}-\d{2}$/.test(cpf)) && valid;
        valid = validateField('rua',   rua.length >= 3)                         && valid;
        valid = validateField('cep',   /^\d{5}-\d{3}$/.test(cep))              && valid;

        if (currentMethod === 'card') {
            const num = document.getElementById('cardNum').value.replace(/\s/g, '');
            valid = validateField('cardnum', num.length === 16)                                   && valid;
            valid = validateField('cardexp', /^\d{2}\/\d{2}$/.test(document.getElementById('cardExp').value)) && valid;
            valid = validateField('cardcvv', document.getElementById('cardCvv').value.length >= 3)            && valid;
        }

        if (!valid) {
            showToast('Por favor, corrija os campos destacados.', 'error');
            const first = document.querySelector('.form-group.error');
            if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        const btn = document.getElementById('btnPagar');
        btn.disabled  = true;
        btn.innerHTML = `
            <span class="btn-loading-inner">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin">
                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83
                             M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                </svg>
                Processando pagamento...
            </span>`;

        setTimeout(() => {
            localStorage.removeItem('carrinho');
            stopPixTimer();
            document.getElementById('successOverlay').classList.add('active');
        }, 2200);
    }

    /* -------------------------------------------------------
       10. TOAST
    ------------------------------------------------------- */
    function showToast(msg, type = 'success') {
        const t = document.createElement('div');
        t.className   = `toast toast--${type}`;
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => { t.classList.add('toast--out'); setTimeout(() => t.remove(), 320); }, 3000);
    }

    /* -------------------------------------------------------
       11. INIT
    ------------------------------------------------------- */
    renderSummary();
    generateQR();
    generateBarcode();
</script>
</body>
</html>